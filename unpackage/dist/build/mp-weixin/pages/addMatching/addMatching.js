"use strict";const e=require("../../common/vendor.js"),t=require("../../common/assets.js"),s={components:{ConfirmModal:()=>"../../components/ConfirmModal.js"},data:()=>({selectedClothes:[],outfitName:"",seasons:["春","夏","秋","冬"],selectedSeason:"请选择季节",outfitCategories:["工作通勤","正式场合","运动休闲","精致约会","出游"],selectedCategory:"请选择类目",note:"",activeIndex:null,startX:0,startY:0,startDistance:null,startRotateX:0,startRotateY:0,showDeleteModal:!1,deleteClothesIndex:null}),onLoad(t){if(t.data){let s=JSON.parse(decodeURIComponent(t.data));if(0===s.length)return void console.log("未选中任何衣物！！");const{windowWidth:o,windowHeight:i}=e.index.getSystemInfoSync(),a=o-80,l=320-80;let n=[];s.forEach((e=>{const t={image:e.image,x:(Math.random()-.5)*a,y:(Math.random()-.5)*l,scale:1,rotation:0};n.push(t)})),this.selectedClothes=n}},methods:{selectCategory(e){this.selectedCategory=this.outfitCategories[e.detail.value]},selectSeason(e){this.selectedSeason=this.seasons[e.detail.value]},getStyle:e=>({transform:`translate(${e.x}px, ${e.y}px) rotate(${e.rotation}deg) scale(${e.scale})`}),selectClothes(e){this.activeIndex=e,console.log("selectClothes"+e)},clearSelection(){this.activeIndex=null},startDrag(e,t){this.activeIndex!==e&&(this.activeIndex=e),this.startX=t.touches[0].clientX-this.selectedClothes[this.activeIndex].x,this.startY=t.touches[0].clientY-this.selectedClothes[this.activeIndex].y},handleMove(e){if(null!==this.activeIndex){let t=e.touches[0].clientX-this.startX,s=e.touches[0].clientY-this.startY;this.selectedClothes[this.activeIndex].x=t,this.selectedClothes[this.activeIndex].y=s}},startRotate(t){if(null===this.activeIndex)return;const s=this.selectedClothes[this.activeIndex];e.index.createSelectorQuery().in(this).select(".clothes-item").boundingClientRect((e=>{if(!e)return;this.centerX=e.left+e.width/2,this.centerY=e.top+e.height/2;const o=t.touches[0].clientX,i=t.touches[0].clientY;this.startAngle=Math.atan2(i-this.centerY,o-this.centerX)*(180/Math.PI),this.startRotation=s.rotation})).exec()},rotateDrag(e){if(null===this.activeIndex)return;const t=e.touches[0].clientX,s=e.touches[0].clientY,o=Math.atan2(s-this.centerY,t-this.centerX)*(180/Math.PI)-this.startAngle;this.selectedClothes[this.activeIndex].rotation=this.startRotation+o},startResize(e){null!==this.activeIndex&&(this.startDistance=Math.hypot(e.touches[0].clientX-this.selectedClothes[this.activeIndex].x,e.touches[0].clientY-this.selectedClothes[this.activeIndex].y))},resizeDrag(e){if(null===this.activeIndex)return;let t=Math.hypot(e.touches[0].clientX-this.selectedClothes[this.activeIndex].x,e.touches[0].clientY-this.selectedClothes[this.activeIndex].y)/this.startDistance;t=Math.max(.5,Math.min(t,2)),this.selectedClothes[this.activeIndex].scale=t},removeClothes(e){this.deleteClothesIndex=e,this.showDeleteModal=!0},navigateToSelectClothes(){},closeDeleteModal(){this.showDeleteModal=!1,this.deleteClothesIndex=null},deleteConfirm(){null!==this.deleteClothesIndex&&(this.selectedClothes.splice(this.deleteClothesIndex,1),this.deleteClothesIndex=null,this.showDeleteModal=!1)},generateUniqueId:()=>"id_"+Date.now().toString(36)+Math.random().toString(36).substr(2,5),async generateThumbnail(){return new Promise(((t,s)=>{const o=e.index.createCanvasContext("outfitCanvas",this);o.setFillStyle("#ffffff"),o.fillRect(0,0,300,300),this.selectedClothes.forEach((e=>{o.save(),o.translate(150+e.x,150+e.y),o.rotate(e.rotation*Math.PI/180),o.scale(e.scale,e.scale),o.drawImage(e.image,-40,-40,80,80),o.restore()})),o.draw(!1,(()=>{e.index.canvasToTempFilePath({canvasId:"outfitCanvas",success:e=>t(e.tempFilePath),fail:e=>s(e)},this)}))}))},async saveOutfit(){if(this.outfitName.trim())if("请选择季节"!==this.selectedSeason)if("请选择类目"!==this.selectedCategory)try{const e=await this.generateThumbnail();this.saveToStorage(e)}catch(t){e.index.showToast({title:"缩略图生成失败",icon:"none"})}else e.index.showToast({title:"请选择类目",icon:"none"});else e.index.showToast({title:"请选择季节",icon:"none"});else e.index.showToast({title:"请输入套装名称",icon:"none"})},saveToStorage(t){const s={id:this.generateUniqueId(),name:this.outfitName,clothes:this.selectedClothes,primaryCategory:this.selectedSeason,secondaryCategory:this.selectedCategory,note:this.note,image:t};let o=e.index.getStorageSync("outfits")||[];o.push(s),e.index.setStorageSync("outfits",o),e.index.showToast({title:"套装已保存",icon:"success"}),setTimeout((()=>{e.index.switchTab({url:"/pages/matching/matching"})}),100)}}};if(!Array){e.resolveComponent("confirm-modal")()}const o=e._export_sfc(s,[["render",function(s,o,i,a,l,n){return e.e({a:e.f(l.selectedClothes,((s,o,i)=>e.e({a:s.image,b:l.activeIndex===o},l.activeIndex===o?{c:t._imports_0$2,d:e.o((e=>n.startRotate(e)),o),e:e.o((e=>n.rotateDrag(e)),o),f:t._imports_1$3,g:e.o((e=>n.startResize(e)),o),h:e.o((e=>n.resizeDrag(e)),o),i:e.o((e=>n.removeClothes(o)),o)}:{},{j:o,k:e.s(n.getStyle(s)),l:e.o((e=>n.startDrag(o,e)),o),m:e.o((e=>n.handleMove(e)),o)}))),b:0===l.selectedClothes.length},(l.selectedClothes.length,{}),{c:e.o(((...e)=>n.clearSelection&&n.clearSelection(...e))),d:e.o(((...e)=>n.navigateToSelectClothes&&n.navigateToSelectClothes(...e))),e:l.outfitName,f:e.o((e=>l.outfitName=e.detail.value)),g:e.t(l.selectedSeason),h:l.seasons,i:e.o(((...e)=>n.selectSeason&&n.selectSeason(...e))),j:e.t(l.selectedCategory),k:l.outfitCategories,l:e.o(((...e)=>n.selectCategory&&n.selectCategory(...e))),m:l.note,n:e.o((e=>l.note=e.detail.value)),o:e.o(((...e)=>n.saveOutfit&&n.saveOutfit(...e))),p:e.o(n.closeDeleteModal),q:e.o(n.deleteConfirm),r:e.p({visible:l.showDeleteModal,title:"确认删除？",message:"",cancelText:"取消",confirmText:"删除"})})}],["__scopeId","data-v-2d222dc4"]]);wx.createPage(o);

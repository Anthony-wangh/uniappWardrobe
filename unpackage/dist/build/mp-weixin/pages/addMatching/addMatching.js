"use strict";const t=require("../../common/vendor.js"),e=require("../../common/assets.js"),s={data:()=>({selectedClothes:[],outfitName:"",note:"",activeIndex:null,startX:0,startY:0,startDistance:null,startRotateX:0,startRotateY:0}),onLoad(e){if(e.clothes){let s=JSON.parse(decodeURIComponent(e.clothes));if(0===s.length)return void console.log("未选中任何衣物！！");const{windowWidth:i,windowHeight:a}=t.index.getSystemInfoSync(),o=i-80,n=320-80;let c=[];s.forEach((t=>{const e={image:t.image,x:(Math.random()-.5)*o,y:(Math.random()-.5)*n,scale:1,rotation:0};c.push(e)})),this.selectedClothes=c}},methods:{getStyle:t=>({transform:`translate(${t.x}px, ${t.y}px) rotate(${t.rotation}deg) scale(${t.scale})`}),selectClothes(t){this.activeIndex=t},clearSelection(){this.activeIndex=null},startDrag(t,e){this.activeIndex=t,this.startX=e.touches[0].clientX-this.selectedClothes[this.activeIndex].x,this.startY=e.touches[0].clientY-this.selectedClothes[this.activeIndex].y},handleMove(t){if(null!==this.activeIndex){let e=t.touches[0].clientX-this.startX,s=t.touches[0].clientY-this.startY;this.selectedClothes[this.activeIndex].x=e,this.selectedClothes[this.activeIndex].y=s}},startRotate(e){if(null===this.activeIndex)return;const s=this.selectedClothes[this.activeIndex];t.index.createSelectorQuery().in(this).select(`#clothesItem${this.activeIndex}`).boundingClientRect((t=>{if(!t)return;this.centerX=t.left+t.width/2,this.centerY=t.top+t.height/2;const i=e.touches[0].clientX,a=e.touches[0].clientY;this.startAngle=Math.atan2(a-this.centerY,i-this.centerX)*(180/Math.PI),this.startRotation=s.rotation})).exec()},rotateDrag(t){if(null===this.activeIndex)return;const e=t.touches[0].clientX,s=t.touches[0].clientY,i=Math.atan2(s-this.centerY,e-this.centerX)*(180/Math.PI)-this.startAngle;this.selectedClothes[this.activeIndex].rotation=this.startRotation+i},startResize(t){null!==this.activeIndex&&(this.startDistance=Math.hypot(t.touches[0].clientX-this.selectedClothes[this.activeIndex].x,t.touches[0].clientY-this.selectedClothes[this.activeIndex].y))},resizeDrag(t){if(null===this.activeIndex)return;let e=Math.hypot(t.touches[0].clientX-this.selectedClothes[this.activeIndex].x,t.touches[0].clientY-this.selectedClothes[this.activeIndex].y)/this.startDistance;e=Math.max(.5,Math.min(e,2)),this.selectedClothes[this.activeIndex].scale=e},removeClothes(e){t.index.showModal({title:"确认删除？",showCancel:!0,cancelText:"取消",cancelColor:"#999",confirmText:"确定",confirmColor:"#212121",success:t=>{t.confirm&&this.selectedClothes.splice(e,1)}})},navigateToSelectClothes(){},generateUniqueId:()=>"id_"+Date.now().toString(36)+Math.random().toString(36).substr(2,5),async generateThumbnail(){return new Promise(((e,s)=>{const i=t.index.createCanvasContext("outfitCanvas",this);i.setFillStyle("#ffffff"),i.fillRect(0,0,300,300),this.selectedClothes.forEach((t=>{console.log("********"+t.rotation),i.save(),i.translate(150+t.x,150+t.y),i.rotate(t.rotation*Math.PI/180),i.scale(t.scale,t.scale),i.drawImage(t.image,-40,-40,80,80),i.restore()})),i.draw(!1,(()=>{t.index.canvasToTempFilePath({canvasId:"outfitCanvas",success:t=>e(t.tempFilePath),fail:t=>s(t)},this)}))}))},async saveOutfit(){if(this.outfitName.trim())try{const t=await this.generateThumbnail();this.saveToStorage(t)}catch(e){t.index.showToast({title:"缩略图生成失败",icon:"none"})}else t.index.showToast({title:"请输入套装名称",icon:"none"})},saveToStorage(e){const s={id:this.generateUniqueId(),name:this.outfitName,note:this.note,thumbnail:e};let i=t.index.getStorageSync("outfits")||[];i.push(s),t.index.setStorageSync("outfits",i),t.index.showToast({title:"套装已保存",icon:"success"}),setTimeout((()=>{t.index.switchTab({url:"/pages/matching/matching"})}),100)}}};const i=t._export_sfc(s,[["render",function(s,i,a,o,n,c){return t.e({a:t.f(n.selectedClothes,((s,i,a)=>t.e({a:s.image,b:t.o((t=>c.startDrag(i,t)),i),c:t.o((t=>c.handleMove(t)),i),d:n.activeIndex===i},n.activeIndex===i?{e:e._imports_0$2,f:t.o((t=>c.startRotate(t)),i),g:t.o((t=>c.rotateDrag(t)),i),h:e._imports_1$2,i:t.o((t=>c.startResize(t)),i),j:t.o((t=>c.resizeDrag(t)),i),k:t.o((t=>c.removeClothes(i)),i)}:{},{l:i,m:"clothesItem"+i,n:"clothesItem"+i,o:t.s(c.getStyle(s))}))),b:0===n.selectedClothes.length},(n.selectedClothes.length,{}),{c:e._imports_1$1,d:t.o(((...t)=>c.navigateToSelectClothes&&c.navigateToSelectClothes(...t))),e:t.o(((...t)=>c.clearSelection&&c.clearSelection(...t))),f:n.outfitName,g:t.o((t=>n.outfitName=t.detail.value)),h:n.note,i:t.o((t=>n.note=t.detail.value)),j:t.o(((...t)=>c.saveOutfit&&c.saveOutfit(...t)))})}],["__scopeId","data-v-35d397fb"]]);wx.createPage(i);

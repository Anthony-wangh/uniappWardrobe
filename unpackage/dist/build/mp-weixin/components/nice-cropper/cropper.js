"use strict";const t=require("../../common/vendor.js"),e=Math.abs,i=t=>Math.sqrt(t.x*t.x+t.y*t.y),s={props:{width:{type:[String,Number],default:"100%"},height:{type:[String,Number],default:"100%"},cutWidth:{type:[String,Number],default:"400px"},cutHeight:{type:[String,Number],default:"400px"},minWidth:{type:Number,default:50},minHeight:{type:Number,default:50},center:{type:Boolean,default:!0},src:String,disableScale:Boolean,disableRotate:Boolean,disableTranslate:Boolean,disableCtrl:Boolean,boundDetect:Boolean,freeBoundDetect:Boolean,keepRatio:Boolean,disablePreview:Boolean,showCtrlBorder:Boolean,resetCut:Boolean,fit:{type:Boolean,default:!0},imageCenter:Boolean,maxZoom:{type:Number,default:10},minZoom:{type:Number,default:1},angle:{type:Number,default:0},zoom:{type:Number,default:2},offset:{type:Array,default:()=>[0,0]},background:{type:String,default:"#000"},canvasBackground:{type:String,default:"#fff"},canvasZoom:{type:Number,default:1},fileType:{type:String,default:"png",validator:t=>["png","jpg"].includes(t)},quality:{type:Number,default:1},maskType:{type:String,default:"shadow"},circleView:Boolean},data:()=>({transform:{angle:0,translate:{x:0,y:0},zoom:1},corner:{left:50,right:50,bottom:50,top:50},image:{originWidth:0,originHeight:0,width:0,height:0},ctrlWidth:0,ctrlHeight:0,view:!1,canvasId:""}),computed:{transformMeta:function(){const t=this.transform;return`translate3d(${t.translate.x}px, ${t.translate.y}px, 0) rotate(${t.angle}deg) scale(${t.zoom})`},ctrlStyle:function(){const t=this.corner;let e=`left: ${t.left}px;top: ${t.top}px;right: ${t.right}px;bottom: ${t.bottom}px;`;return"outline"!==this.maskType?e+=`box-shadow: 0 0 0 50000rpx rgba(0,0,0, ${this.view?.8:.4})`:e+=`outline: rgba(0,0,0, ${this.view?.8:.4}) solid 5000px`,e}},watch:{src:function(){this.resetCut&&this.resetCutReact(),this.initImage()}},created(){this.canvasId=(()=>{const t="abcdefghijklmnopqrstuvwxyz",e=t.split("").concat(t.toUpperCase().split("")).concat("0123456789".split(""));let i,s=e.length;for(;s;){i=Math.floor(Math.random()*s--);const t=e[s];e[s]=e[i],e[i]=t}return e.slice(0,16).join("")})(),t.index.getSystemInfo().then((t=>{t=t[1]||{windowWidth:375,windowHeight:736},this.ratio=t.windowWidth/750,this.windowHeight=t.windowHeight,this.init(),this.initCanvas()}))},methods:{toPx(t){return-1!==t.indexOf("%")?Math.floor(Number(t.replace("%",""))/100*this.containerWidth):-1!==t.indexOf("rpx")?Math.floor(Number(t.replace("rpx",""))*this.ratio):Math.floor(Number(t.replace("px","")))},initCanvas(){const e=t.index.createSelectorQuery().in(this);e.select(".nice-cropper").boundingClientRect(),e.exec((t=>{this.containerWidth=t[0].width,this.containerHeight=t[0].height,this.initCut()}))},resetCutReact(){this.ctrlWidth=Math.min(this.toPx(this.cutWidth),this.containerWidth),this.cutHeight?this.ctrlHeight=Math.min(this.toPx(this.cutHeight),this.containerHeight):this.ctrlHeight=Math.min(this.ctrlWidth,this.containerHeight);const t=this.center?Math.floor((this.containerWidth-this.ctrlWidth)/2):0,e=this.center?Math.floor((this.containerHeight-this.ctrlHeight)/2):0;this.cutRatio=this.ctrlHeight/this.ctrlWidth,this.corner={left:t,right:this.containerWidth-this.ctrlWidth-t,top:e,bottom:this.containerHeight-this.ctrlHeight-e}},initCut(){this.resetCutReact(),this.initImage()},async initImage(){if(!this.src)return;try{const e=await t.index.getImageInfo({src:this.src});this.$emit("load",e),this.image.originWidth=e.width,this.image.originHeight=e.height,this.image.width=this.fit?this.ctrlWidth:this.image.originWidth,this.image.height=e.height/e.width*this.image.width,this.img=e.path}catch(i){this.$emit("error",i),this.image.originWidth=this.ctrlWidth,this.image.originHeight=this.ctrlHeight,this.image.width=this.ctrlWidth,this.image.height=this.ctrlHeight}const e=[0,0];this.imageCenter&&(e[0]=(this.ctrlWidth-this.image.width)/2,e[1]=(this.ctrlHeight-this.image.height)/2),e[0]+=this.offset[0]||0,e[1]+=this.offset[1]||0,this.setTranslate(e),this.setZoom(this.zoom),this.transform.angle=this.freeBoundDetect||!this.disableRotate?this.angle:0,this.setBoundary(),this.preview(),this.draw()},init(){this.pretouch={},this.handles={},this.preVector={x:0,y:0},this.distance=30,this.touch={},this.movetouch={},this.cutMode=!1,this.params={zoom:1,deltaX:0,deltaY:0,diffX:0,diffY:0,angle:0}},start(t){this.src||t.preventDefault();const s=t.touches?t.touches[0]:t,a=this.touch,h=Date.now();if(a.startX=s.pageX,a.startY=s.pageY,a.startTime=h,this.doubleTap=!1,this.view=!1,clearTimeout(this.previewTimer),t.touches.length>1){var r=t.touches[1];this.preVector={x:r.pageX-this.touch.startX,y:r.pageY-this.touch.startY},this.startDistance=i(this.preVector)}else{let t=this.pretouch;this.doubleTap=this.pretouch.time&&h-this.pretouch.time<300&&e(a.startX-t.startX)<30&&e(a.startY-t.startY)<30&&e(a.startTime-t.time)<300,t={startX:this.touch.startX,startY:this.touch.startY,time:this.touch.startTime}}},move(t){if(!this.src)return;const s=t.touches?t.touches[0]:t;if(t.touches.length>1){const e=t.touches[1],l={x:e.pageX-s.pageX,y:e.pageY-s.pageY};if(null!==this.preVector.x){if(this.startDistance){const t=i(l);this.params.zoom=i(l)/this.startDistance,this.startDistance=t,this.cutMode&&!this.disableCtrl?this.setCut():!this.disableScale&&this.pinch()}this.params.angle=(a=l,h=this.preVector,(n=i(a)*i(h))?(r=(a.x*h.x+a.y*h.y)/n,o=Math.acos(Math.min(r,1)),180*(o=a.x*h.y-h.x*a.y>0?-o:o)/Math.PI):0),this.cutMode&&!this.disableCtrl?this.setCut():!this.disableRotate&&this.rotate()}this.preVector.x=l.x,this.preVector.y=l.y}else{const t=s.pageX-this.touch.startX,i=s.pageY-this.touch.startY;this.params.diffY=i,this.params.diffX=t,this.movetouch.x?(this.params.deltaX=s.pageX-this.movetouch.x,this.params.deltaY=s.pageY-this.movetouch.y):this.params.deltaX=this.params.deltaY=0,(e(t)>30||e(i)>30)&&(this.doubleTap=!1),this.cutMode&&!this.disableCtrl?this.setCut():!this.disableTranslate&&this.translate(),this.movetouch.x=s.pageX,this.movetouch.y=s.pageY}var a,h,r,o,n;!this.cutMode&&this.setBoundary(),t.touches.length>1&&t.preventDefault()},end(){this.doubleTap&&this.$emit("doubleTap"),this.cutMode&&this.setBoundary(),this.init(),!this.disablePreview&&this.preview(),this.draw()},translate(){const t=this.transform.translate,e=this.params;t.x+=e.deltaX,t.y+=e.deltaY},pinch(){this.transform.zoom*=this.params.zoom},rotate(){this.transform.angle+=this.params.angle},setZoom(t){t=Math.min(Math.max(Number(t)||1,this.minZoom),this.maxZoom),this.transform.zoom=t},setTranslate(t){if(Array.isArray(t)){const e=Number(t[0]),i=Number(t[1]);this.transform.translate.x=isNaN(e)?this.transform.translate.x:this.corner.left+e,this.transform.translate.y=isNaN(i)?this.transform.translate.y:this.corner.top+i}},setRotate(t){this.transform.angle=Number(t)||0},setTransform(t,e,i,s){this.setTranslate([t,e]),this.setZoom(s),this.setRotate(i)},setCutMode(t){this.src&&(this.disableCtrl||(this.cutMode=!0,this.cutDirection=t))},setCut(){const t=this.corner,e=this.params;switch(this.setMeta(this.cutDirection,e),this.keepRatio&&("lt"===this.cutDirection||"rb"===this.cutDirection?e.deltaY=e.deltaX*this.cutRatio:e.deltaX=e.deltaY/this.cutRatio),this.cutDirection){case"lt":t.top+=e.deltaY,t.left+=e.deltaX;break;case"rt":t.top+=e.deltaY,t.right-=this.keepRatio?-e.deltaX:e.deltaX;break;case"rb":t.right-=e.deltaX,t.bottom-=e.deltaY;break;case"lb":t.bottom-=e.deltaY,t.left+=this.keepRatio?-e.deltaX:e.deltaX}this.ctrlWidth=this.containerWidth-t.left-t.right,this.ctrlHeight=this.containerHeight-t.top-t.bottom},setMeta(t,e){const{ctrlWidth:i,ctrlHeight:s,minWidth:a,minHeight:h}=this;switch(t){case"lt":(e.deltaX>0||e.deltaY>0)&&(e.deltaX=Math.min(e.deltaX,i-a),e.deltaY=Math.min(e.deltaY,s-h));break;case"rt":(e.deltaX<0||e.deltaY>0)&&(e.deltaX=Math.max(e.deltaX,a-i),e.deltaY=Math.min(e.deltaY,s-h));break;case"rb":(e.deltaX<0||e.deltaY<0)&&(e.deltaX=Math.max(e.deltaX,a-i),e.deltaY=Math.max(e.deltaY,h-s));break;case"lb":(e.deltaX>0||e.deltaY<0)&&(e.deltaX=Math.min(e.deltaX,i-a),e.deltaY=Math.max(e.deltaY,h-s))}},setBoundary(){let t=this.transform.zoom;if(t=t<this.minZoom?this.minZoom:t>this.maxZoom?this.maxZoom:t,this.transform.zoom=t,!this.boundDetect||!this.disableRotate&&!this.freeBoundDetect)return!0;const e=this.transform.translate,i=this.corner,s=i.left-this.image.width+this.ctrlWidth-this.image.width*(t-1)/2,a=i.left+this.image.width*(t-1)/2,h=i.top-this.image.height+this.ctrlHeight-this.image.height*(t-1)/2,r=i.top+this.image.height*(t-1)/2;e.x=Math.floor(e.x<s?s:e.x>a?a:e.x),e.y=Math.floor(e.y<h?h:e.y>r?r:e.y)},preview(){clearTimeout(this.previewTimer),this.previewTimer=setTimeout((()=>{this.view=!0}),500)},draw(){const e=t.index.createCanvasContext(this.canvasId,this),i=this.transform,s=this.corner,a=this.canvasZoom,h=this.image;e.save(),e.setFillStyle(this.canvasBackground),this.$emit("beforeDraw",e,i);const r=i.zoom;e.fillRect(0,0,this.ctrlWidth*a,this.ctrlHeight*a),e.translate((i.translate.x-s.left+h.width/2)*a,(i.translate.y-s.top+h.height/2)*a),e.rotate(i.angle*Math.PI/180),e.translate(-h.width*r*.5*a,-h.height*r*.5*a),e.drawImage(this.img,0,0,h.width*r*a,h.height*r*a),e.restore(),this.$emit("afterDraw",e,{width:this.ctrlWidth*a,height:this.ctrlHeight*a}),e.draw(!1,(()=>{t.index.canvasToTempFilePath({canvasId:this.canvasId,quality:this.quality||1,fileType:this.fileType,success:t=>{this.$emit("cropped",t.tempFilePath,{originWidth:this.image.originWidth,originHeight:this.image.originHeight,width:this.ctrlWidth*a,height:this.ctrlHeight*a,scale:r,translate:{x:i.translate.x,y:i.translate.y},rotate:i.angle})}},this)}))}}};const a=t._export_sfc(s,[["render",function(e,i,s,a,h,r){return t.e({a:e.src,b:e.transformMeta,c:e.image.width+"px",d:e.image.height+"px",e:t.o((t=>e.setCutMode("lt"))),f:t.o((t=>e.setCutMode("rt"))),g:t.o((t=>e.setCutMode("rb"))),h:t.o((t=>e.setCutMode("lb"))),i:e.view?1:"",j:e.showCtrlBorder?1:"",k:e.view&&e.circleView&&"outline"!==e.maskType?1:"",l:t.s(e.ctrlStyle),m:e.canvasId},e.canvasId?{n:e.canvasId,o:e.canvasId,p:e.ctrlWidth*e.canvasZoom+"px",q:e.ctrlHeight*e.canvasZoom+"px"}:{},{r:e.height,s:e.width,t:e.background,v:t.o(((...t)=>e.start&&e.start(...t))),w:t.o(((...t)=>e.move&&e.move(...t))),x:t.o(((...t)=>e.end&&e.end(...t))),y:t.o(((...t)=>e.end&&e.end(...t)))})}]]);wx.createComponent(a);
